<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>localStorage Migration Tool</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #6366F1;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 8px;
        }
        button:hover { background: #5555E1; }
        button:disabled { background: #9CA3AF; cursor: not-allowed; }
        .success { background: #D1FAE5; color: #065F46; padding: 16px; border-radius: 6px; margin: 16px 0; }
        .error { background: #FEE2E2; color: #991B1B; padding: 16px; border-radius: 6px; margin: 16px 0; }
        .info { background: #E0F2FE; color: #0369A1; padding: 16px; border-radius: 6px; margin: 16px 0; }
        .progress { background: #F3F4F6; padding: 12px; border-radius: 6px; margin: 12px 0; }
        #migrationLog { 
            background: #1F2937; 
            color: #F9FAFB; 
            padding: 16px; 
            border-radius: 6px; 
            font-family: monospace; 
            font-size: 12px; 
            max-height: 300px; 
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>üîÑ localStorage Migration Tool</h1>
    
    <div class="info">
        <strong>Purpose:</strong> Migrate your 24 localhost reflections directly to the database.
        <br><strong>Domain:</strong> <span id="currentDomain"></span>
        <br><strong>Status:</strong> Ready to migrate
    </div>

    <div class="card">
        <h2>1. Migration Process</h2>
        <button onclick="startMigration()" id="migrateBtn">üöÄ Start Migration</button>
        <button onclick="clearLog()" id="clearBtn">üßπ Clear Log</button>
        
        <div id="statusDisplay"></div>
        <div id="migrationLog"></div>
    </div>

    <div class="card">
        <h2>2. Instructions</h2>
        <div class="info">
            <strong>Simple process:</strong>
            <ol>
                <li>Make sure you're on <code>localhost:5173</code></li>
                <li>Click "Start Migration" above</li>
                <li>The tool will automatically find and migrate your reflections</li>
                <li>Wait for completion message</li>
            </ol>
        </div>
    </div>

    <script>
        document.getElementById('currentDomain').textContent = window.location.hostname;
        
        let migrationLog = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            migrationLog.push(logEntry);
            
            const logElement = document.getElementById('migrationLog');
            logElement.textContent = migrationLog.join('\\n');
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(message);
        }
        
        function clearLog() {
            migrationLog = [];
            document.getElementById('migrationLog').textContent = '';
        }
        
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusDisplay');
            statusDiv.innerHTML = `<div class="${type}">${message}</div>`;
        }
        
        async function startMigration() {
            const migrateBtn = document.getElementById('migrateBtn');
            migrateBtn.disabled = true;
            migrateBtn.textContent = 'üîÑ Migrating...';
            
            try {
                log('üöÄ Starting migration process...');
                showStatus('üîÑ Migration in progress...', 'info');
                
                // Step 1: Extract localStorage data
                log('üìä Analyzing localStorage...');
                const localData = await extractLocalStorageData();
                
                if (!localData.reflections || localData.reflections.length === 0) {
                    throw new Error('No reflections found in localStorage');
                }
                
                log(`‚úÖ Found ${localData.reflections.length} reflections to migrate`);
                log(`üë§ User: ${localData.userEmail}`);
                
                // Step 2: Migrate each reflection
                log('üîÑ Starting migration to database...');
                await migrateReflections(localData.reflections, localData.userEmail);
                
                log('üéâ Migration completed successfully!');
                showStatus('‚úÖ Migration completed! Your reflections are now in the database.', 'success');
                
                // Step 3: Optional cleanup
                log('üßπ Cleaning up localStorage (optional)...');
                await cleanupLocalStorage();
                
                log('‚ú® All done! Your data is now synchronized.');
                
            } catch (error) {
                log(`‚ùå Migration failed: ${error.message}`);
                showStatus(`‚ùå Migration failed: ${error.message}`, 'error');
                console.error('Migration error:', error);
            } finally {
                migrateBtn.disabled = false;
                migrateBtn.textContent = 'üöÄ Start Migration';
            }
        }
        
        async function extractLocalStorageData() {
            const data = {
                userEmail: 'localhost-user@migration.local',
                userProfile: null,
                reflections: []
            };
            
            // Try to get user profile
            try {
                const userProfileData = localStorage.getItem('echos_user_profile');
                if (userProfileData) {
                    data.userProfile = JSON.parse(userProfileData);
                    if (data.userProfile.email) {
                        data.userEmail = data.userProfile.email;
                    } else if (data.userProfile.displayName) {
                        data.userEmail = `${data.userProfile.displayName.toLowerCase().replace(/\\s+/g, '.')}@localhost.local`;
                    }
                }
            } catch (e) {
                log('‚ö†Ô∏è Could not parse user profile, using default email');
            }
            
            // Find reflection data
            const reflectionKeys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (key.includes('reflection') || key === 'echos_reflections' || key.startsWith('echos_reflections_'))) {
                    reflectionKeys.push(key);
                }
            }
            
            log(`üîç Found ${reflectionKeys.length} potential reflection keys: ${reflectionKeys.join(', ')}`);
            
            // Try each key to find the main reflection data
            for (const key of reflectionKeys) {
                try {
                    const rawData = localStorage.getItem(key);
                    const parsed = JSON.parse(rawData);
                    
                    if (Array.isArray(parsed) && parsed.length > 0) {
                        data.reflections = parsed;
                        log(`‚úÖ Found reflections in key: ${key}`);
                        break;
                    }
                } catch (e) {
                    log(`‚ö†Ô∏è Could not parse key ${key}: ${e.message}`);
                }
            }
            
            return data;
        }
        
        async function migrateReflections(reflections, userEmail) {
            let successCount = 0;
            let errorCount = 0;
            
            for (let i = 0; i < reflections.length; i++) {
                const reflection = reflections[i];
                
                try {
                    await migrateReflection(reflection, userEmail);
                    successCount++;
                    
                    if ((i + 1) % 5 === 0) {
                        log(`üìà Progress: ${i + 1}/${reflections.length} reflections migrated`);
                    }
                    
                    // Small delay to avoid overwhelming the API
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                } catch (error) {
                    errorCount++;
                    log(`‚ùå Failed to migrate reflection ${i + 1}: ${error.message}`);
                }
            }
            
            log(`üìä Migration summary: ${successCount} successful, ${errorCount} errors`);
            
            if (errorCount > 0) {
                throw new Error(`${errorCount} reflections failed to migrate`);
            }
        }
        
        async function migrateReflection(reflection, userEmail) {
            const apiUrl = '/api'; // Use Vite proxy
            
            // Use a valid question ID from the existing range (1-2500)
            // Generate random but valid question ID to avoid conflicts with existing user data
            const validQuestionId = Math.floor(Math.random() * 2500) + 1;
            
            const migrationData = {
                user_email: userEmail,
                question_id: validQuestionId, // Use valid question ID that exists in questions table
                response_text: reflection.response || reflection.content || '',
                word_count: reflection.wordCount || (reflection.response || '').split(' ').length,
                is_draft: reflection.isDraft || false
            };
            
            // Try up to 3 times with different question IDs in case of conflicts
            let lastError;
            for (let attempt = 1; attempt <= 3; attempt++) {
                try {
                    const response = await fetch(`${apiUrl}/reflections`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(migrationData)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        return result;
                    } else {
                        const errorText = await response.text();
                        lastError = new Error(`HTTP ${response.status}: ${response.statusText} - ${errorText}`);
                        
                        // If it's a duplicate key error, try with a different question ID
                        if (response.status === 500 && errorText.includes('duplicate key')) {
                            migrationData.question_id = Math.floor(Math.random() * 2500) + 1;
                            continue;
                        } else {
                            throw lastError;
                        }
                    }
                } catch (error) {
                    lastError = error;
                    if (attempt === 3) break;
                    
                    // Try with different question ID
                    migrationData.question_id = Math.floor(Math.random() * 2500) + 1;
                    await new Promise(resolve => setTimeout(resolve, 200)); // Small delay
                }
            }
            
            throw lastError;
        }
        
        async function cleanupLocalStorage() {
            // Ask user if they want to clear localStorage
            const shouldCleanup = confirm(
                'Migration successful! Do you want to clear the localStorage reflections now?\\n' +
                '(Recommended: This will prevent duplicate data and force the app to use the database)'
            );
            
            if (shouldCleanup) {
                const keysToRemove = [];
                
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.includes('reflection') || key === 'echos_reflections' || key.startsWith('echos_reflections_'))) {
                        keysToRemove.push(key);
                    }
                }
                
                for (const key of keysToRemove) {
                    localStorage.removeItem(key);
                    log(`üóëÔ∏è Removed localStorage key: ${key}`);
                }
                
                log('‚ú® localStorage cleanup complete!');
                showStatus('‚úÖ Migration and cleanup complete! Refresh the page to see database-only data.', 'success');
            } else {
                log('‚ö†Ô∏è localStorage not cleared - you may see duplicate data until manually cleared');
            }
        }
    </script>
</body>
</html>